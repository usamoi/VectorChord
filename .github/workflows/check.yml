name: Check

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  style:
    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'job: -style')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.body, 'job: -style')) ||
      github.event_name == 'workflow_dispatch'

    runs-on: "ubuntu-24.04"

    steps:
      - name: Set up Environment
        run: |
          curl -fsSL https://github.com/tamasfe/taplo/releases/download/0.10.0/taplo-linux-$(uname -m).gz | gzip -d - | install -m 755 /dev/stdin /usr/local/bin/taplo

          curl -fsSL https://github.com/EmbarkStudios/cargo-deny/releases/download/0.18.9/cargo-deny-0.18.9-$(uname -m)-unknown-linux-musl.tar.gz | tar -xOzf - cargo-deny-0.18.9-$(uname -m)-unknown-linux-musl/cargo-deny | install -m 755 /dev/stdin /usr/local/bin/cargo-deny

      - name: Install Rust
        run: rustup update

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Typos
        uses: crate-ci/typos@master

      - name: Taplo
        run: taplo fmt --check

      - name: Ruff
        uses: astral-sh/ruff-action@57714a7c8a2e59f32539362ba31877a1957dded1 # v3.5.1

      - name: Rustfmt
        run: cargo fmt --check -- --config-path /dev/null --config imports_granularity=Module

      - name: Deny
        run: cargo deny check

      - name: License Header
        run: |
          HEADER=$(cat <<EOF
          This software is licensed under a dual license model:

          GNU Affero General Public License v3 (AGPLv3): You may use, modify, and
          distribute this software under the terms of the AGPLv3.

          Elastic License v2 (ELv2): You may also use, modify, and distribute this
          software under the Elastic License v2, which has specific restrictions.

          We welcome any commercial collaboration or support. For inquiries
          regarding the licenses, please contact us at:
          vectorchord-inquiry@tensorchord.ai

          Copyright (c) 2025 TensorChord Inc.
          EOF
          )
          COUNT=$(echo "$HEADER" | wc -l)

          RS_HEADER=$(echo "$HEADER" | awk '{ if ($0 ~ /^$/) print "//"; else print "// " $0 }')
          C_HEADER=$(echo "$HEADER" | awk '{ if ($0 ~ /^$/) print "//"; else print "// " $0 }')
          PY_HEADER=$(echo "$HEADER" | awk '{ if ($0 ~ /^$/) print "#"; else print "# " $0 }')

          RS_FILES=$(find . -type f -name "*.rs" -not -path "./target/*")
          C_FILES=$(find . -type f -name "*.c" -not -path "./target/*")
          PY_FILES=$(find . -type f -name "*.py" -not -path "./target/*")

          FLAG="0"

          for p in $RS_FILES; do
            if ! head -n "$COUNT" "$p" | cmp -s - <(echo "$RS_HEADER"); then
              echo "license header mismatch in file $p"
              FLAG="1"
            fi
          done

          for p in $C_FILES; do
            if ! head -n "$COUNT" "$p" | cmp -s - <(echo "$C_HEADER"); then
              echo "license header mismatch in file $p"
              FLAG="1"
            fi
          done

          for p in $PY_FILES; do
            if ! head -n "$COUNT" "$p" | cmp -s - <(echo "$PY_HEADER"); then
              echo "license header mismatch in file $p"
              FLAG="1"
            fi
          done

          if [ "$FLAG" -eq "1" ]; then
            exit 1
          fi

      - name: SQL
        run: |
          ! grep -P '\t' -r ./sql

  miri:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +miri')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +miri')) ||
      github.event_name == 'workflow_dispatch'

    runs-on: "ubuntu-24.04"

    env:
      RUSTUP_AUTO_INSTALL: "0"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Install Rust
        run: |
          rustup default nightly
          rustup component add miri

      - name: Install Clang
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 18
          echo CC=clang-18 >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Cargo Test (Miri)
        env:
          RUSTFLAGS: "-Ctarget-cpu=sapphirerapids"
          MIRIFLAGS: "-Zmiri-strict-provenance"
        run: |
          cargo miri test --locked --target x86_64-unknown-linux-gnu \
            --workspace --exclude vchord --no-fail-fast \
            -- --no-capture --test-threads=1

  lint:
    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'job: -lint')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.body, 'job: -lint')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        arch: ["x86_64", "aarch64"]
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          sudo apt-get update

          if [ "$(uname -m)" == "x86_64" ]; then
            wget https://downloadmirror.intel.com/859732/sde-external-9.58.0-2025-06-16-lin.tar.xz -O /tmp/sde-external.tar.xz
            sudo tar -xf /tmp/sde-external.tar.xz -C /opt
            sudo mv /opt/sde-external-9.58.0-2025-06-16-lin /opt/sde
          fi

          if [ "$(uname -m)" == "aarch64" ]; then          
            sudo apt-get install -y qemu-user-static
          fi

      - name: Install Rust
        run: rustup update

      - name: Install Clang
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 18
          echo CC=clang-18 >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Cargo Test
        run: cargo test --locked --workspace --exclude vchord --no-fail-fast -- --no-capture

      - name: Cargo Test (QEMU)
        run: |
          if [ "$(uname -m)" == "x86_64" ]; then
            cargo \
              --config 'target.'\''cfg(all())'\''.runner = ["/opt/sde/sde64", "-spr", "--"]' \
              test --locked -p simd -- --no-capture
          fi
          if [ "$(uname -m)" == "aarch64" ]; then
            cargo \
              --config 'target.'\''cfg(all())'\''.runner = ["qemu-aarch64-static", "-cpu", "max,sve-default-vector-length=16"]' \
              test --locked -p simd -- --no-capture
            cargo \
              --config 'target.'\''cfg(all())'\''.runner = ["qemu-aarch64-static", "-cpu", "max,sve-default-vector-length=32"]' \
              test --locked -p simd -- --no-capture
            cargo \
              --config 'target.'\''cfg(all())'\''.runner = ["qemu-aarch64-static", "-cpu", "max,sve-default-vector-length=64"]' \
              test --locked -p simd -- --no-capture
          fi

      - name: Clippy
        run: cargo clippy --locked --workspace --exclude vchord

  psql:
    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'job: -psql')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.body, 'job: -psql')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        version: ["14", "15", "16", "17", "18"]
        arch: ["x86_64", "aarch64"]
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-22.04' || 'ubuntu-22.04-arm' }}

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          sudo apt-get update

          curl -fsSL https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-$(uname -m)-unknown-linux-musl.tar.gz | tar -xOzf - ./sqllogictest | install -m 755 /dev/stdin /usr/local/bin/sqllogictest

      - name: Install Rust
        run: rustup update

      - name: Install Clang
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 18
          echo CC=clang-18 >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Install PostgreSQL & pgvector
        run: |
          sudo apt-get remove -y '^postgres.*' '^libpq.*'
          sudo apt-get purge -y '^postgres.*' '^libpq.*'

          sudo apt-get install -y --no-install-recommends postgresql-common
          sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
          sudo apt-get install -y --no-install-recommends postgresql-server-dev-${{ matrix.version }}
          sudo apt-get install -y --no-install-recommends postgresql-${{ matrix.version }}

          echo "local all all trust" | sudo tee /etc/postgresql/${{ matrix.version }}/main/pg_hba.conf
          echo "host all all 127.0.0.1/32 trust" | sudo tee -a /etc/postgresql/${{ matrix.version }}/main/pg_hba.conf
          echo "host all all ::1/128 trust" | sudo tee -a /etc/postgresql/${{ matrix.version }}/main/pg_hba.conf

          sudo mkdir -p /etc/systemd/system/postgresql@.service.d/
          echo "[Service]" | sudo tee /etc/systemd/system/postgresql@.service.d/limit.conf
          echo "LimitNOFILE=infinity" | sudo tee -a /etc/systemd/system/postgresql@.service.d/limit.conf
          echo "LimitMEMLOCK=infinity" | sudo tee -a /etc/systemd/system/postgresql@.service.d/limit.conf
          sudo systemctl daemon-reload

          sudo -iu postgres createuser -s -r $(whoami)
          sudo -iu postgres createdb -O $(whoami) $(whoami)
          if [ "${{ matrix.version }}" -ge "18" ]; then
            psql -c 'ALTER SYSTEM SET io_method = io_uring'
          fi
          psql -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          psql -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          sudo systemctl stop postgresql

          pg_config
          echo PG_CONFIG=pg_config >> $GITHUB_ENV

          sudo apt-get install -y --no-install-recommends postgresql-${{ matrix.version }}-pgvector

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Clippy
        run: make PROFILE=dev clippy

      - name: Build
        run: make PROFILE=dev build

      - name: Install
        run: sudo make PG_CONFIG=$PG_CONFIG install

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: postgresql-${{ matrix.version }}-vchord_0.0.0_${{ matrix.arch }}-linux-gnu
          path: ./build
          compression-level: 9
          retention-days: 14

      - name: Service
        run: |
          sudo systemctl start postgresql
          psql -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $(whoami) --user $(whoami) './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if [ "${{ matrix.version }}" -ge "17" ]; then
            sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          fi

      - name: Logging
        if: always()
        run: |
          cat /var/log/postgresql/postgresql-${{ matrix.version }}-main.log

  psql_macos:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +psql_macos')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +psql_macos')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        version: ["14", "15", "16", "17", "18"]
        arch: ["aarch64", "x86_64"]

    runs-on: ${{ matrix.arch == 'aarch64' && 'macos-15' || 'macos-15-intel' }}

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          brew update

          curl -fsSL https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-${{ matrix.arch }}-apple-darwin.tar.gz | tar -xOzf - ./sqllogictest | tee /usr/local/bin/sqllogictest > /dev/null && chmod 755 /usr/local/bin/sqllogictest

      - name: Install Rust
        run: rustup update

      - name: Install Clang
        run: echo CC=$(brew --prefix llvm@18)/bin/clang >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
        with:
          version: "v0.12.0"

      - name: Install PostgreSQL & pgvector
        run: |
          brew install postgresql@${{ matrix.version }}
          brew services start postgresql@${{ matrix.version }}
          for i in {1..60}; do [ -S /tmp/.s.PGSQL.5432 ] && echo "PostgreSQL ready" && break || sleep 1; done
          [ -S /tmp/.s.PGSQL.5432 ] || echo "PostgreSQL socket not found after 60 seconds"

          $(brew --prefix postgresql@${{ matrix.version }})/bin/createdb -O $(whoami) $(whoami)
          $(brew --prefix postgresql@${{ matrix.version }})/bin/psql -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          $(brew --prefix postgresql@${{ matrix.version }})/bin/psql -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          brew services stop postgresql@${{ matrix.version }}

          $(brew --prefix postgresql@${{ matrix.version }})/bin/pg_config
          echo PG_CONFIG=$(brew --prefix postgresql@${{ matrix.version }})/bin/pg_config >> $GITHUB_ENV

          mkdir ~/pgvector-install
          curl -fsSL https://github.com/pgvector/pgvector/archive/refs/tags/v0.8.1.tar.gz | tar -xz -C ~/pgvector-install
          make -C ~/pgvector-install/pgvector-0.8.1 PG_CONFIG=$(brew --prefix postgresql@${{ matrix.version }})/bin/pg_config CC='sccache clang'
          sudo make -C ~/pgvector-install/pgvector-0.8.1 PG_CONFIG=$(brew --prefix postgresql@${{ matrix.version }})/bin/pg_config CC='sccache clang' install

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Clippy
        run: make PROFILE=dev clippy

      - name: Build
        run: make PROFILE=dev build

      - name: Install
        run: sudo make PG_CONFIG=$PG_CONFIG install

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: postgresql-${{ matrix.version }}-vchord_0.0.0_${{ matrix.arch }}-apple-darwin
          path: ./build
          compression-level: 9
          retention-days: 14

      - name: Service
        run: |
          brew services start postgresql@${{ matrix.version }}
          for i in {1..60}; do [ -S /tmp/.s.PGSQL.5432 ] && echo "PostgreSQL ready" && break || sleep 1; done
          [ -S /tmp/.s.PGSQL.5432 ] || echo "PostgreSQL socket not found after 60 seconds"
          $(brew --prefix postgresql@${{ matrix.version }})/bin/psql -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $(whoami) --user $(whoami) './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if [ "${{ matrix.version }}" -ge "17" ]; then
            sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          fi

      - name: Logging
        if: always()
        run: |
          cat $(brew --prefix)/var/log/postgresql@${{ matrix.version }}.log

  psql_windows:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +psql_windows')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +psql_windows')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        version: ["14", "15", "16", "17", "18"]
        arch: ["x86_64"]

    runs-on: "windows-2022"

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          Invoke-WebRequest -Uri https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-${{ matrix.arch }}-pc-windows-msvc.zip -OutFile "$env:TEMP\sqllogictest-install.zip"
          Expand-Archive -Path "$env:TEMP\sqllogictest-install.zip" -DestinationPath "D:\sqllogictest-install" -Force
          Add-Content -Path $env:GITHUB_PATH -Value "D:\sqllogictest-install"

      - name: Install Rust
        run: rustup update

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Install PostgreSQL & pgvector
        run: |
          'PGBIN','PGDATA','PGROOT', 'PGUSER', 'PGPASSWORD' | ForEach-Object { Remove-Item "env:$_" }

          if ( "${{ matrix.version }}" -eq "14" ) {
            $postgresql_url = "https://get.enterprisedb.com/postgresql/postgresql-14.20-2-windows-x64-binaries.zip"
          }
          if ( "${{ matrix.version }}" -eq "15" ) {
            $postgresql_url = "https://get.enterprisedb.com/postgresql/postgresql-15.15-2-windows-x64-binaries.zip"
          }
          if ( "${{ matrix.version }}" -eq "16" ) {
            $postgresql_url = "https://get.enterprisedb.com/postgresql/postgresql-16.11-2-windows-x64-binaries.zip"
          }
          if ( "${{ matrix.version }}" -eq "17" ) {
            $postgresql_url = "https://get.enterprisedb.com/postgresql/postgresql-17.7-2-windows-x64-binaries.zip"
          }
          if ( "${{ matrix.version }}" -eq "18" ) {
            $postgresql_url = "https://get.enterprisedb.com/postgresql/postgresql-18.1-2-windows-x64-binaries.zip"
          }
          Invoke-WebRequest -Uri $postgresql_url -OutFile "$env:TEMP\postgresql-install.zip"
          Expand-Archive -Path "$env:TEMP\postgresql-install.zip" -DestinationPath "D:\postgresql-install" -Force
          D:\postgresql-install\pgsql\bin\initdb.exe -D D:\postgresql-install\pgsql\data -U postgres

          D:\postgresql-install\pgsql\bin\pg_ctl.exe start -D D:\postgresql-install\pgsql\data -l D:\postgresql-install\postgresql.log

          D:\postgresql-install\pgsql\bin\createuser.exe -U postgres -s -r $env:USERNAME
          D:\postgresql-install\pgsql\bin\createdb.exe -O $env:USERNAME $env:USERNAME
          D:\postgresql-install\pgsql\bin\psql.exe -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          D:\postgresql-install\pgsql\bin\psql.exe -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          D:\postgresql-install\pgsql\bin\pg_ctl.exe stop -D D:\postgresql-install\pgsql\data

          D:\postgresql-install\pgsql\bin\pg_config.exe
          Add-Content -Path $env:GITHUB_ENV -Value "PG_CONFIG=D:\postgresql-install\pgsql\bin\pg_config.exe"

          Invoke-WebRequest -Uri "https://github.com/pgvector/pgvector/archive/refs/tags/v0.8.1.zip" -OutFile "$env:TEMP\pgvector-install.zip"
          Expand-Archive -Path "$env:TEMP\pgvector-install.zip" -DestinationPath "D:\pgvector-install" -Force
          & 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\Launch-VsDevShell.ps1' -HostArch amd64 -Arch amd64
          Push-Location -Path D:\pgvector-install\pgvector-0.8.1
          nmake /F Makefile.win PGROOT="D:\postgresql-install\pgsql"
          nmake /F Makefile.win PGROOT="D:\postgresql-install\pgsql" install
          Pop-Location

      - name: Install Clang
        run: Add-Content -Path $env:GITHUB_ENV -Value "CC=clang-cl.exe"

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Clippy
        run: make PROFILE=dev clippy

      - name: Build
        run: make PROFILE=dev build

      - name: Install
        run: make install

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: postgresql-${{ matrix.version }}-vchord_0.0.0_${{ matrix.arch }}-pc-windows-msvc
          path: ./build
          compression-level: 9
          retention-days: 14

      - name: Service
        run: |
          'PGBIN','PGDATA','PGROOT', 'PGUSER', 'PGPASSWORD' | ForEach-Object { Remove-Item "env:$_" }

          D:\postgresql-install\pgsql\bin\pg_ctl.exe start -D D:\postgresql-install\pgsql\data -l D:\postgresql-install\postgresql.log
          D:\postgresql-install\pgsql\bin\psql.exe -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $env:USERNAME --user $env:USERNAME './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $env:USERNAME --user $env:USERNAME './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $env:USERNAME --user $env:USERNAME './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if ( "${{ matrix.version }}" -ge "17" ) {
            sqllogictest --db $env:USERNAME --user $env:USERNAME './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          }

      - name: Logging
        if: always()
        run: |
          Get-Content -Path 'D:\postgresql-install\postgresql.log'

  psql_alpine:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +psql_alpine')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +psql_alpine')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        version: ["15", "16", "17"]
        arch: ["x86_64", "aarch64"]
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}
    container:
      image: alpine:3.22
      volumes:
        - /opt:/opt:rw,rshared
        - /opt:/__e/node20:ro,rshared
        - /opt:/__e/node24:ro,rshared

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      # RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          sed -i "/^ID=/s/alpine/NotpineForGHA/" /etc/os-release
          apk add --update-cache curl git make nodejs sudo zip
          mkdir /opt/bin
          ln -s /usr/bin/node /opt/bin/node

          curl -fsSL https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-$(uname -m)-unknown-linux-musl.tar.gz | tar -xOzf - ./sqllogictest | install -m 755 /dev/stdin /usr/local/bin/sqllogictest

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain beta
          echo $HOME/.cargo/bin >> $GITHUB_PATH
          echo RUSTC_BOOTSTRAP=1 >> $GITHUB_ENV

      - name: Install Clang
        run: |
          sudo apk add --no-cache clang18 clang18-dev
          echo CC=clang-18 >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Install PostgreSQL & pgvector
        run: |
          sudo apk add --no-cache postgresql${{ matrix.version }} postgresql${{ matrix.version }}-dev
          sudo touch /var/log/postgresql.log
          sudo chmod 644 /var/log/postgresql.log
          sudo chown postgres /var/log/postgresql.log
          sudo install --verbose --directory --owner postgres --group postgres --mode 1777 /var/lib/postgresql
          sudo install --verbose --directory --owner postgres --group postgres --mode 1777 /var/lib/postgresql/data
          sudo install --verbose --directory --owner postgres --group postgres --mode 3777 /run/postgresql
          sudo -iu postgres initdb -D /var/lib/postgresql/data

          sudo -iu postgres pg_ctl start -D /var/lib/postgresql/data -l /var/log/postgresql.log

          sudo -iu postgres createuser -s -r $(whoami)
          sudo -iu postgres createdb -O $(whoami) $(whoami)
          if [ "${{ matrix.version }}" -ge "18" ]; then
            psql -c 'ALTER SYSTEM SET io_method = io_uring'
          fi
          psql -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          psql -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          sudo -iu postgres pg_ctl stop -D /var/lib/postgresql/data

          /usr/libexec/postgresql${{ matrix.version }}/pg_config
          echo PG_CONFIG=/usr/libexec/postgresql${{ matrix.version }}/pg_config >> $GITHUB_ENV

          mkdir ~/pgvector-install
          curl -fsSL https://github.com/pgvector/pgvector/archive/refs/tags/v0.8.1.tar.gz | tar -xz -C ~/pgvector-install
          make -C ~/pgvector-install/pgvector-0.8.1 PG_CONFIG=/usr/libexec/postgresql${{ matrix.version }}/pg_config CC='sccache clang-18'
          make -C ~/pgvector-install/pgvector-0.8.1 PG_CONFIG=/usr/libexec/postgresql${{ matrix.version }}/pg_config CC='sccache clang-18' install

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Patch
        run: |
          mkdir ./.cargo && touch ./.cargo/config.toml
          cat << EOF > ./.cargo/config.toml
          unstable.host-config = true
          unstable.target-applies-to-host = true
          host.rustflags = ["-Dwarnings", "-Ctarget-feature=-crt-static"]
          build.rustflags = ["-Dwarnings", "-Ctarget-feature=-crt-static"]
          EOF

      - name: Clippy
        run: make PROFILE=dev clippy

      - name: Build
        run: make PROFILE=dev build

      - name: Install
        run: sudo make PG_CONFIG=$PG_CONFIG install

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: postgresql-${{ matrix.version }}-vchord_0.0.0_${{ matrix.arch }}-linux-musl
          path: ./build
          compression-level: 9
          retention-days: 14

      - name: Service
        run: |
          sudo -iu postgres pg_ctl start -D /var/lib/postgresql/data -l /var/log/postgresql.log
          psql -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $(whoami) --user $(whoami) './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if [ "${{ matrix.version }}" -ge "17" ]; then
            sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          fi

      - name: Logging
        if: always()
        run: |
          cat /var/log/postgresql.log

  check_debian:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +check_debian')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +check_debian')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        include:
          - version: "15"
            platform: "s390x"
            clang_triple: "s390x-linux-gnu"
            rust_triple: "s390x-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "17"
            platform: "s390x"
            clang_triple: "s390x-linux-gnu"
            rust_triple: "s390x-unknown-linux-gnu"
            gcc_version: "14"
            debian_version: "trixie"
          - version: "14"
            platform: "ppc64le"
            clang_triple: "powerpc64le-linux-gnu"
            rust_triple: "powerpc64le-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "15"
            platform: "ppc64le"
            clang_triple: "powerpc64le-linux-gnu"
            rust_triple: "powerpc64le-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "16"
            platform: "ppc64le"
            clang_triple: "powerpc64le-linux-gnu"
            rust_triple: "powerpc64le-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "17"
            platform: "ppc64le"
            clang_triple: "powerpc64le-linux-gnu"
            rust_triple: "powerpc64le-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "18"
            platform: "ppc64le"
            clang_triple: "powerpc64le-linux-gnu"
            rust_triple: "powerpc64le-unknown-linux-gnu"
            gcc_version: "12"
            debian_version: "bookworm"
          - version: "17"
            platform: "riscv64"
            clang_triple: "riscv64-linux-gnu"
            rust_triple: "riscv64gc-unknown-linux-gnu"
            gcc_version: "14"
            debian_version: "trixie"
    runs-on: "ubuntu-24.04"

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      # RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static
          sudo systemctl enable --now systemd-binfmt
          sudo touch /etc/sudoers.d/qemu
          echo "Defaults env_keep += \"QEMU_CPU\"" | sudo tee -a /etc/sudoers.d/qemu
          sudo mkdir /sysroot
          curl -fsSL https://github.com/debuerreotype/docker-debian-artifacts/raw/refs/heads/dist-${{ matrix.platform }}/${{ matrix.debian_version }}/oci/blobs/rootfs.tar.gz | sudo tar -xz -C /sysroot
          sudo mount --bind /dev /sysroot/dev
          sudo mount --bind /dev/pts /sysroot/dev/pts
          sudo mount --bind /etc/resolv.conf /sysroot/etc/resolv.conf
          sudo mount --bind /proc /sysroot/proc
          sudo mount --bind /sys /sysroot/sys
          sudo mount --bind /tmp /sysroot/tmp
          sudo chroot /sysroot apt-get update
          sudo chroot /sysroot apt-get install --no-install-recommends -y libc6-dev libgcc-${{ matrix.gcc_version }}-dev
          sudo chroot /sysroot apt-get install --no-install-recommends -y ca-certificates sudo
          QEMU_LD_PREFIX=/sysroot
          QEMU_CPU=max
          if [ "${{ matrix.platform }}" = "ppc64le" ]; then
            sudo rm -f /sysroot/lib64/ld64.so.2
            sudo ln /sysroot/usr/lib/powerpc64le-linux-gnu/ld64.so.2 /sysroot/lib64/ld64.so.2
            sudo rm -f /sysroot/usr/lib/powerpc64le-linux-gnu/libm.so
            sudo ln /sysroot/lib/powerpc64le-linux-gnu/libm.so.6 /sysroot/usr/lib/powerpc64le-linux-gnu/libm.so
            QEMU_CPU=power10
          fi
          export QEMU_LD_PREFIX
          export QEMU_CPU
          echo QEMU_LD_PREFIX=$QEMU_LD_PREFIX >> $GITHUB_ENV
          echo QEMU_CPU=$QEMU_CPU >> $GITHUB_ENV

          curl -fsSL https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-$(uname -m)-unknown-linux-musl.tar.gz | tar -xOzf - ./sqllogictest | install -m 755 /dev/stdin /usr/local/bin/sqllogictest

      - name: Install Rust
        run: |
          rustup default beta
          rustup component add rustfmt clippy
          rustup target add ${{ matrix.rust_triple }}
          echo RUSTC_BOOTSTRAP=1 >> $GITHUB_ENV

      - name: Install Clang
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://apt.llvm.org/llvm.sh | sudo bash -s -- 18
          echo CC=clang-18 >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Install PostgreSQL & pgvector
        run: |
          sudo apt-get remove -y '^postgres.*' '^libpq.*'
          sudo apt-get purge -y '^postgres.*' '^libpq.*'

          sudo chroot /sysroot apt-get install -y --no-install-recommends postgresql-common
          sudo chroot /sysroot /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
          sudo chroot /sysroot apt-get install -y --no-install-recommends postgresql-server-dev-${{ matrix.version }}
          sudo chroot /sysroot apt-get install -y --no-install-recommends postgresql-${{ matrix.version }}

          echo "local all all trust" | sudo tee /sysroot/etc/postgresql/${{ matrix.version }}/main/pg_hba.conf
          echo "host all all 127.0.0.1/32 trust" | sudo tee -a /sysroot/etc/postgresql/${{ matrix.version }}/main/pg_hba.conf
          echo "host all all ::1/128 trust" | sudo tee -a /sysroot/etc/postgresql/${{ matrix.version }}/main/pg_hba.conf

          sudo chroot /sysroot pg_ctlcluster ${{ matrix.version }} main start

          sudo chroot /sysroot sudo -iu postgres createuser -s -r $(whoami)
          sudo chroot /sysroot sudo -iu postgres createdb -O $(whoami) $(whoami)
          if [ "${{ matrix.version }}" -ge "18" ]; then
            sudo chroot /sysroot sudo -iu postgres psql -c 'ALTER SYSTEM SET io_method = worker'
          fi
          sudo chroot /sysroot sudo -iu postgres psql -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          sudo chroot /sysroot sudo -iu postgres psql -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          sudo chroot /sysroot pg_ctlcluster ${{ matrix.version }} main stop

          sudo touch /usr/bin/pg_config
          echo "#!/usr/bin/env bash" | sudo tee -a /usr/bin/pg_config
          echo "sudo chroot /sysroot pg_config \"\$@\" \\" | sudo tee -a /usr/bin/pg_config
          echo "    | sed -E 's|^/(.*)$|/sysroot/\1|' \\" | sudo tee -a /usr/bin/pg_config
          echo "    | sed -E 's|^([A-Z]+) = /(.*)$|\1 = /sysroot/\2|'" | sudo tee -a /usr/bin/pg_config
          sudo chmod 755 /usr/bin/pg_config

          pg_config
          echo PG_CONFIG=pg_config >> $GITHUB_ENV

          mkdir ~/pgvector-install
          curl -fsSL https://github.com/pgvector/pgvector/archive/refs/tags/v0.8.1.tar.gz | tar -xz -C ~/pgvector-install
          make -C ~/pgvector-install/pgvector-0.8.1 with_llvm=no CC='sccache clang' CFLAGS="-fuse-ld=lld --target=${{ matrix.clang_triple }} --sysroot=/sysroot" OPTFLAGS=""
          sudo make -C ~/pgvector-install/pgvector-0.8.1 with_llvm=no CC='sccache clang' CFLAGS="-fuse-ld=lld --target=${{ matrix.clang_triple }} --sysroot=/sysroot" OPTFLAGS="" install

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Patch
        run: |
          mkdir ./.cargo && touch ./.cargo/config.toml
          cat << EOF > ./.cargo/config.toml
          [target.${{ matrix.rust_triple }}]
          runner = ["qemu-${{ matrix.platform }}-static"]
          linker = "clang"
          rustflags = [
              "-Clink-arg=-fuse-ld=lld",
              "-Clink-arg=--target=${{ matrix.clang_triple }}",
              "-Clink-arg=--sysroot=/sysroot",
              "-Dwarnings",
          ]
          [env]
          CFLAGS_${{ matrix.rust_triple }} = "--target=${{ matrix.clang_triple }} --sysroot=/sysroot"
          BINDGEN_EXTRA_CLANG_ARGS_${{ matrix.rust_triple }} = "--sysroot=/sysroot"
          EOF

      - name: Cargo Test
        run: cargo test --locked --target ${{ matrix.rust_triple }} --workspace --exclude vchord --no-fail-fast -- --no-capture

      - name: Clippy
        run: make TARGET=${{ matrix.rust_triple }} PROFILE=dev RUNNER='qemu-${{ matrix.platform }}-static' clippy

      - name: Build
        run: make TARGET=${{ matrix.rust_triple }} PROFILE=dev RUNNER='qemu-${{ matrix.platform }}-static' build

      - name: Install
        run: sudo make PG_CONFIG=$PG_CONFIG install

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: postgresql-${{ matrix.version }}-vchord_0.0.0_${{ matrix.clang_triple }}
          path: ./build
          compression-level: 9
          retention-days: 14

      - name: Service
        run: |
          sudo chroot /sysroot pg_ctlcluster ${{ matrix.version }} main start
          sudo chroot /sysroot psql -d $(whoami) -U $(whoami) -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $(whoami) --user $(whoami) './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if [ "${{ matrix.version }}" -ge "17" ]; then
            sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          fi

      - name: Logging
        if: always()
        run: |
          cat /sysroot/var/log/postgresql/postgresql-${{ matrix.version }}-main.log

  check_arch:
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, 'job: +check_arch')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'job: +check_arch')) ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        version: ["17", "18"]

    runs-on: "ubuntu-24.04"

    container:
      image: archlinux/archlinux:base-devel
      volumes:
        - /etc/passwd:/etc/passwd:rw,rshared
        - /etc/group:/etc/group:rw,rshared
        - /etc/shadow:/etc/shadow:rw,rshared
        - /etc/gshadow:/etc/gshadow:rw,rshared
        - /etc/sudoers.d/runner:/etc/sudoers.d/runner:rw,rshared
      options: --user 1001 --privileged

    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTUP_AUTO_INSTALL: "0"
      RUSTC_WRAPPER: "sccache"
      RUSTFLAGS: "-Dwarnings"
      CARGO_TERM_COLOR: "always"
      RUST_BACKTRACE: "1"

    steps:
      - name: Set up Environment
        run: |
          sudo sed -i 's/^DownloadUser = alpm$/DownloadUser = runner/' /etc/pacman.conf
          sudo pacman -Syu --ignore systemd,systemd-libs,systemd-sysvcompat --noconfirm git nodejs
          sudo mkdir -p /var/lib/postgresql
          sudo chmod 700 /var/lib/postgresql
          sudo chown postgres:postgres /var/lib/postgresql

          sudo pacman -S --noconfirm liburing numactl python valgrind

          curl -fsSL https://github.com/risinglightdb/sqllogictest-rs/releases/download/v0.29.0/sqllogictest-bin-v0.29.0-$(uname -m)-unknown-linux-musl.tar.gz | tar -xOzf - ./sqllogictest | sudo install -m 755 /dev/stdin /usr/local/bin/sqllogictest

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain beta
          echo $HOME/.cargo/bin >> $GITHUB_PATH
          echo RUSTC_BOOTSTRAP=1 >> $GITHUB_ENV

      - name: Install Clang
        run: |
          sudo pacman -S --noconfirm clang
          echo CC=clang >> $GITHUB_ENV

      - name: Set up Sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Install PostgreSQL & pgvector
        run: |
          mkdir ~/postgresql-install
          if [ "${{ matrix.version }}" = "17" ]; then
            curl -fsSL https://ftp.postgresql.org/pub/source/v17.6/postgresql-17.6.tar.bz2 | tar -xj -C ~/postgresql-install
            pushd ~/postgresql-install/postgresql-17.6
          fi
          if [ "${{ matrix.version }}" = "18" ]; then
            curl -fsSL https://ftp.postgresql.org/pub/source/v18.0/postgresql-18.0.tar.bz2 | tar -xj -C ~/postgresql-install
            pushd ~/postgresql-install/postgresql-18.0
          fi
          ./configure \
              --prefix=/usr \
              --sysconfdir=/etc \
              --mandir=/usr/share/man \
              --datadir=/usr/share/postgresql \
              --disable-rpath \
              --enable-nls \
              --with-gssapi \
              --with-icu \
              --with-ldap \
              --with-lz4 \
              --with-openssl \
              --with-python \
              --with-readline \
              --with-system-tzdata=/usr/share/zoneinfo \
              --with-uuid=e2fs \
              --with-zstd \
              ${{ matrix.version >= 18 && '--with-libcurl'  || '' }} \
              ${{ matrix.version >= 18 && '--with-libnuma'  || '' }} \
              ${{ matrix.version >= 18 && '--with-liburing' || '' }} \
              --enable-debug \
              --enable-cassert \
              CC='sccache clang' \
              CFLAGS='-O0 -g -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fasynchronous-unwind-tables' \
              CPPFLAGS='-DUSE_ASSERT_CHECKING=1 -DRANDOMIZE_ALLOCATED_MEMORY=1 -DUSE_VALGRIND=1'
          make all -j$(nproc)
          sudo make install
          popd

          sudo touch /usr/bin/postmaster
          echo '#!/usr/bin/sh' | sudo tee -a /usr/bin/postmaster
          echo 'export DEBUGINFOD_URLS=https://debuginfod.archlinux.org' | sudo tee -a /usr/bin/postmaster
          echo 'exec \' | sudo tee -a /usr/bin/postmaster
          echo '  valgrind \' | sudo tee -a /usr/bin/postmaster
          echo '  --leak-check=no \' | sudo tee -a /usr/bin/postmaster
          echo '  --gen-suppressions=all \' | sudo tee -a /usr/bin/postmaster
          echo '  --time-stamp=yes \' | sudo tee -a /usr/bin/postmaster
          echo '  --error-markers=VALGRINDERROR-BEGIN,VALGRINDERROR-END \' | sudo tee -a /usr/bin/postmaster
          echo '  --trace-children=yes \' | sudo tee -a /usr/bin/postmaster
          echo '  /usr/bin/postgres "$@"' | sudo tee -a /usr/bin/postmaster
          sudo chmod 755 /usr/bin/postmaster
          sudo mkdir -p /var/lib/postgres
          sudo chmod 700 /var/lib/postgres
          sudo chown postgres:postgres /var/lib/postgres
          sudo touch /var/log/postgresql.log
          sudo chmod 700 /var/log/postgresql.log
          sudo chown postgres:postgres /var/log/postgresql.log
          sudo -iu postgres initdb -D /var/lib/postgres/data
          sudo -iu postgres pg_ctl start -D /var/lib/postgres/data -l /var/log/postgresql.log -p /usr/bin/postmaster

          sudo -iu postgres createuser -s -r $(whoami)
          sudo -iu postgres createdb -O $(whoami) $(whoami)
          if [ "${{ matrix.version }}" -ge "18" ]; then
            sudo -iu postgres psql -c 'ALTER SYSTEM SET io_method = io_uring'
          fi
          sudo -iu postgres psql -c 'ALTER SYSTEM SET max_worker_processes = 1024'
          sudo -iu postgres psql -c 'ALTER SYSTEM SET shared_preload_libraries = "vchord"'
          sudo -iu postgres pg_ctl stop -D /var/lib/postgres/data

          pg_config
          echo PG_CONFIG=pg_config >> $GITHUB_ENV

          mkdir ~/pgvector-install
          curl -fsSL https://github.com/pgvector/pgvector/archive/refs/tags/v0.8.1.tar.gz | tar -xz -C ~/pgvector-install
          pushd ~/pgvector-install/pgvector-0.8.1
          make -j$(nproc)
          sudo make install
          popd

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Cargo Test
        run: cargo test --locked --workspace --exclude vchord --no-fail-fast -- --no-capture

      - name: Clippy
        run: make PROFILE=dev clippy

      - name: Build
        run: make PROFILE=dev build

      - name: Install
        run: sudo make PG_CONFIG=$PG_CONFIG install

      - name: Service
        run: |
          sudo -iu postgres pg_ctl start -D /var/lib/postgres/data -l /var/log/postgresql.log -p /usr/bin/postmaster
          psql -c 'CREATE EXTENSION IF NOT EXISTS vchord CASCADE;'

      - name: Sqllogictest
        run: |
          sqllogictest --db $(whoami) --user $(whoami) './tests/general/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordg/*.slt' --label pg${{ matrix.version }}
          sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/*.slt' --label pg${{ matrix.version }}
          if [ "${{ matrix.version }}" -ge "17" ]; then
            sqllogictest --db $(whoami) --user $(whoami) './tests/vchordrq/pg17/*.slt' --label pg${{ matrix.version }}
          fi

      - name: Logging
        if: always()
        run: |
          sudo cat /var/log/postgresql.log
